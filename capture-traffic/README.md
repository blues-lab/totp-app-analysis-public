# Using open source tools to capture plaintext network traffic

These instructions explain how to use open source tools to capture the plaintext
HTTP(S) traffic generated by Android apps while performing security and privacy
research.

These instructions assume the use of a Pixel phone, since that is what we used
in our research. If you are not using a Pixel phone, then you may need to search
online for additional instructions since the steps to root a phone vary between
device manufacturers.

The tools include:

- [Magisk](https://github.com/topjohnwu/Magisk/blob/master/docs/install.md)
  -  Magisk is a suite of open source software for customizing Android,
     supporting devices higher than Android 5.0.

- [MagiskTrustUserCerts](https://github.com/NVISOsecurity/MagiskTrustUserCerts)
  - A Magisk module that copies user CA certs to system CA certs so that they
    are always trusted by apps.

- [mitmproxy](https://mitmproxy.org/)
  - mitmproxy is a free and open source interactive HTTPS proxy.

The directions in each sub-section below explain how to set up a Pixel Android
phone to proxy HTTP(S) traffic through a running mitmproxy instance on a laptop
connected via the Android Debud Bridge (adb).

## Step 1) Install dependencies on laptop

###  Android Debug Bridge (adb)

The [Android Debug Bridge
(adb)](https://developer.android.com/studio/command-line/adb) is required to
flash the ROM onto Android devices.

There are several ways to install `adb`:

1. [Android Studio](https://developer.android.com/studio#downloads)
   - Approximate size: 1 Gb
   - Useful if you plan to work with the Android Emulator and/or want an IDE for Android development.

2. [Android platform-tools only](https://developer.android.com/studio/releases/platform-tools)
   - Approximate size: 30 MB unzipped
   - Useful if you plan to work with an Android phone and only want adb.
   - Unzip the platform tools wherever you like and add them to your `PATH`.

### mitmproxy

The [mitmproxy](https://github.com/mitmproxy/mitmproxy) project is open source
and has a healthy ecosystem of contributors and maintainers. You can find
[installation docs
here](https://docs.mitmproxy.org/stable/overview-installation/).

## Step 2) Configure Pixel phone for flashing new ROMs

1. Enable developer mode and USB debugging on the phone
   ([docs](https://developer.android.com/studio/debug/dev-options#enable))

   - On Phone
     - `Settings` > `About Phone` and tap `Build number` 7 times
     - `Settings` > `System` > `Advanced` > `Developer options`
     - Enable `USB debugging` ("Debug mode when USB is connected.")

2. Unlock the phone bootloader
   ([docs](https://source.android.com/setup/build/running#unlocking-the-bootloader))

   **WARNING**: This will wipe ***all*** data on the phone.

   - On Phone
     - `Settings` > `System` > `Advanced` > `Developer options`
     - Enable `OEM unlocking` ("Allow the bootloader to be unlocked")
   - On Laptop
     - `$> adb reboot bootloader`
     - `$> fastboot flashing unlock`
   - On Phone
     - Use volume buttons to navigate the menu and highlight `Unlock the bootloader`
     - Press the power button

## Step 3) Root the Pixel phone with Magisk

- Ensure that the phone can be detected by adb. Example:

   ```
   $> adb devices -l
   List of devices attached
   97QAY11JVZ             device usb:336666624X product:sargo model:Pixel_3a device:sargo transport_id:1
   ```
- On laptop
  - `$> cd capture-traffic`
  - `$> ./configure-for-mitmproxy.sh`
    - This script uses adb to:
      - download/install the [Magisk APK](https://github.com/topjohnwu/Magisk/releases) on the phone
      - download the [MagiskTrustUserCerts
    module](https://github.com/NVISOsecurity/MagiskTrustUserCerts/releases/) and
    upload it to the phone's Download folder
  - Follow the [Magisk
    instructions](https://github.com/conorgil/Magisk/blob/patch-1/docs/install.md)
    on how to patch the `boot.img` image file and flash it onto the Android
    phone
      - If you are using the Android factory image [sargo 9.0.0
(PD2A.190115.032, Mar
        2019)](https://dl.google.com/dl/android/aosp/sargo-pd2a.190115.032-factory-c0068fd4.zip),
        then the boot image that Magisk requires is in the zip file called
        `sargo-pd2a.190115.032-factory-c0068fd4.zip/image-sargo-pd2a.190115.032.zip/boot.img`
  - `$> ./configure-for-mitmproxy.sh`
    - The phone will reboot as part of flashing the patched boot file, so run
      this script again because the `adb reverse` setting is ephemeral
  - Start mitmproxy ([instructions here](https://docs.mitmproxy.org/stable/overview-getting-started/))
- On phone:
  - Install mitmproxy cert by visiting http://mitm.it
  - Open the Magisk app. Click the `Modules` puzzle piece in the bottom right >
    Install from storage > navigate to the MagiskTrustUserCerts module zip
  - Reboot the phone. The MagiskTrustUserCerts module will copy the mitmproxy
    cert from the user trust store to the system trust store.
- On laptop:
  - `$> ./configure-for-mitmproxy.sh`
    - After the phone reboots, run this script again because the `adb reverse`
      setting is ephemeral
- On the phone:
  - Use any app and the traffic should show up in the mitmproxy running on the
    laptop (unless it is using SSL pinning)
    - mitmproxy docs on tools to remove SSL pinning:
      https://docs.mitmproxy.org/stable/concepts-certificates/#certificate-pinning
